<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D Drone Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
      @font-face {
        font-family: 'Airstike Laser';
        src: url('./airstrikelaser.ttf') format('truetype');
      }
      @font-face {
        font-family: 'Roboto Medium';
        src: url('./Roboto-Medium.ttf') format('truetype');
      }

      body {
        margin: 0;
        overflow: hidden;
      }
      canvas {
        display: block;
      }
      #header {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100px;
        background: gray;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px;
        box-sizing: border-box;
        color: white;
        font-family: 'Airstike Laser', sans-serif;
        font-size: 67px;
      }
      #serial-select {
        font-size: 16px;
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        background: #444;
        color: white;
        cursor: pointer;
        transition: background 0.3s;
      }
      #serial-select:hover {
        background: #666;
      }
      #serial-select:focus {
        outline: none;
        background: #888;
      }
      #data-bar {
        position: absolute;
        top: 200px;
        left: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        font-family: Arial, sans-serif;
      }
      #connect-button {
        padding: 10px 20px;
        background: linear-gradient(135deg, #2196f3, #0d47a1);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-family: 'Roboto Medium', sans-serif;
        font-size: 16px;
        font-weight: 500;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      #connect-button:hover {
        background: linear-gradient(135deg, #42a5f5, #1976d2);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
      }

      #connect-button:active {
        background: linear-gradient(135deg, #0d47a1, #1565c0);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        transform: translateY(1px);
      }
    </style>
  </head>
  <body>
    <div id="header">
      <a href="https://github.com/yourusername" target="_blank" style="display: flex; align-items: center; text-decoration: none; color: white">
        <svg height="32" width="32" viewBox="0 0 16 16" version="1.1" fill="white">
          <path
            fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"
          ></path>
        </svg>
      </a>
      <span>KODOX</span>
      <button id="connect-button">Connect Serial</button>
    </div>
    <div id="data-bar">Waiting for data...</div>

    <script>
      // Setup Scene
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Lighting
      const lightLeft = new THREE.DirectionalLight(0xffffff, 1);
      lightLeft.position.set(-5, 5, 5);
      scene.add(lightLeft);

      const lightRight = new THREE.DirectionalLight(0xffffff, 1);
      lightRight.position.set(5, 5, 5);
      scene.add(lightRight);

      const ambientLight = new THREE.AmbientLight(0x404040, 1);
      scene.add(ambientLight);

      // Orbit Controls
      const controls = new THREE.OrbitControls(camera, renderer.domElement);

      let drone;

      // Load STL Model
      const loader = new THREE.STLLoader();
      loader.load('drone.stl', function (geometry) {
        const material = new THREE.MeshStandardMaterial({ color: 0x0077ff, metalness: 0.5, roughness: 0.5 });
        drone = new THREE.Mesh(geometry, material);
        drone.scale.set(0.025, 0.025, 0.025);
        drone.rotation.x = -Math.PI / 2;
        scene.add(drone);
      });

      camera.position.z = 5;

      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();

      // Serial Data Parsing
      function updateDataBar(data) {
        const fields = data.split(',');
        if (fields.length === 12) {
          document.getElementById('data-bar').innerText =
            `Roll: ${fields[0]} | Pitch: ${fields[1]} | Yaw: ${fields[2]} | ` +
            `Radio Roll: ${fields[3]} | Radio Pitch: ${fields[4]} | Radio Yaw: ${fields[5]} | ` +
            `Throttle: ${fields[6]} | Arming: ${fields[7]} | W1: ${fields[8]} | W2: ${fields[9]} | W3: ${fields[10]} | W4: ${fields[11]}`;

          if (drone) {
            drone.rotation.x = THREE.MathUtils.degToRad(parseFloat(fields[1]));
            drone.rotation.y = THREE.MathUtils.degToRad(parseFloat(fields[2]));
            drone.rotation.z = THREE.MathUtils.degToRad(parseFloat(fields[0]));
          }
        }
      }

      // Serial Communication
      document.getElementById('connect-button').addEventListener('click', async () => {
        try {
          const port = await navigator.serial.requestPort();
          await port.open({ baudRate: 115200 });
          const reader = port.readable.getReader();
          let dataBuffer = '';

          while (true) {
            const { value, done } = await reader.read();
            if (done) {
              reader.releaseLock();
              break;
            }
            dataBuffer += new TextDecoder().decode(value);
            let lines = dataBuffer.split('\n');
            dataBuffer = lines.pop();
            lines.forEach((line) => updateDataBar(line.trim()));
          }
        } catch (error) {
          console.error('Error reading serial data: ', error);
        }
      });
    </script>
  </body>
</html>
